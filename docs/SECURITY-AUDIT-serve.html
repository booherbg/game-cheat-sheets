<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Security Audit: `scripts/serve.js`</title>
  <style>
    body { font-family: system-ui, sans-serif; font-size: 14px; line-height: 1.5; max-width: 48rem; margin: 0 auto; padding: 0rem 1.5rem; }
    h1 { font-size: 1.5rem; border-bottom: 1px solid #ccc; padding-bottom: 0.25em; }
    h2 { font-size: 1.25rem;}
    h3 { font-size: 1.1rem;}
    ul { padding-left: 1.5em; }
    hr { border: none; border-top: 1px solid #ccc; margin: 1.5em 0; }
    .page { page-break-after: always; }
  </style>
</head>
<body>
<h1>Security Audit: <code>scripts/serve.js</code></h1>
<p><strong>Scope:</strong> Local dev server that serves generated cheat-sheet HTML and a dynamic index.<br><strong>Threat model:</strong> Unauthorized access, path traversal, XSS, information disclosure, unintended network exposure.</p>
<hr>
<h2>Findings &amp; Mitigations</h2>
<h3>1. Path traversal (directory traversal)</h3>
<p><strong>Risk:</strong> Requesting <code>..</code> or encoded variants (e.g. <code>%2e%2e%2f</code>) to read files outside the project root.</p>
<p><strong>Analysis:</strong></p>
<ul>
<li>URL <code>pathname</code> is decoded once by <code>URL</code>. We split on <code>/</code> and require exactly two segments <code>[folder, filename]</code>.</li>
<li><code>folder</code> must be in the allowlist (from <code>discoverFoldersWithHtml()</code>). <code>..</code> is never allowlisted.</li>
<li><code>filename</code> is rejected if it contains <code>..</code>, <code>/</code>, or <code>\</code>.</li>
<li><code>serveFile</code> builds <code>filepath = path.join(root, folder, filename)</code>, resolves it, and checks <code>resolved.startsWith(path.resolve(root, folder))</code> so we never serve outside <code>root/folder</code>.</li>
</ul>
<p><strong>Verdict:</strong> Mitigated. No change required beyond existing checks.</p>
<hr>
<h3>2. Symlink escape</h3>
<p><strong>Risk:</strong> A symlink inside a served folder (e.g. <code>euchre/evil</code>) pointing to <code>/etc/passwd</code> could expose external files.</p>
<p><strong>Analysis:</strong></p>
<ul>
<li><code>path.resolve(filepath)</code> resolves the symlink. We then require <code>resolved.startsWith(path.resolve(root, folder))</code>.</li>
<li>A link to <code>/etc/passwd</code> resolves outside <code>root/folder</code>, so the check fails and we return 403.</li>
</ul>
<p><strong>Verdict:</strong> Mitigated.</p>
<hr>
<h3>3. Cross-site scripting (XSS) in index</h3>
<p><strong>Risk:</strong> Folder or filename (used in index HTML) contains <code>&lt;script&gt;</code>, <code>&quot;</code>, etc., leading to injected script.</p>
<p><strong>Analysis:</strong></p>
<ul>
<li>We use <code>escapeHtml()</code> for <code>href</code>, link text (<code>base</code>), and <code>h2</code> (<code>folder</code>). We escape <code>&amp;</code>, <code>&lt;</code>, <code>&gt;</code>, <code>&quot;</code>.</li>
<li>Attributes use double quotes; single quotes were not escaped. In standard HTML that’s acceptable, but escaping <code>&#39;</code> too is defense-in-depth.</li>
</ul>
<p><strong>Verdict:</strong> Low risk. <strong>Fix applied:</strong> Escape <code>&#39;</code> as <code>&amp;#39;</code> in <code>escapeHtml</code>.</p>
<hr>
<h3>4. Unintended network exposure</h3>
<p><strong>Risk:</strong> <code>server.listen(port)</code> binds to all interfaces (<code>0.0.0.0</code>). If the host is reachable (LAN, cloud), others can access the server.</p>
<p><strong>Analysis:</strong></p>
<ul>
<li>This is a “review locally” dev server. Binding to all interfaces increases exposure without clear benefit.</li>
</ul>
<p><strong>Verdict:</strong> <strong>Fix applied:</strong> Listen on <code>HOST</code> (default <code>127.0.0.1</code>) only. Port remains <code>PORT</code> (default 3000).</p>
<hr>
<h3>5. Null bytes in path segments</h3>
<p><strong>Risk:</strong> Filename containing <code>\0</code> (e.g. <code>euchre.html%00</code>) could confuse <code>path</code>/<code>fs</code> on some setups or bypass checks.</p>
<p><strong>Analysis:</strong></p>
<ul>
<li>URL pathname typically doesn’t include nulls, but explicitly rejecting them is simple and robust.</li>
</ul>
<p><strong>Verdict:</strong> <strong>Fix applied:</strong> Reject <code>filename</code> if it includes <code>\0</code>.</p>
<hr>
<h3>6. HTTP method</h3>
<p><strong>Risk:</strong> We don’t check <code>req.method</code>. PUT/POST/DELETE etc. are handled like GET (read-only), but restricting to GET aligns with “static server” and reduces odd behavior.</p>
<p><strong>Analysis:</strong></p>
<ul>
<li>No state is modified. Restricting to GET is a hygiene improvement.</li>
</ul>
<p><strong>Verdict:</strong> <strong>Fix applied:</strong> Return 405 for non-GET with <code>Allow: GET</code>. HEAD is not supported.</p>
<hr>
<h3>7. Information disclosure</h3>
<p><strong>Risk:</strong> Leaking stack traces, internal paths, or directory listings outside allowlisted folders.</p>
<p><strong>Analysis:</strong></p>
<ul>
<li>We return plain “Not Found” or “Forbidden” with no server-generated details.</li>
<li>Only allowlisted folders (those containing <code>.html</code>) are considered; we never expose <code>node_modules</code>, <code>scripts</code>, etc.</li>
</ul>
<p><strong>Verdict:</strong> Acceptable. No change.</p>
<hr>
<h3>8. Double URL decoding / encoded path tricks</h3>
<p><strong>Analysis:</strong></p>
<ul>
<li>We use <code>URL.pathname</code> only; Node decodes once. We don’t decode again.</li>
<li>Traversal via encoded <code>../</code> still yields two path segments only when we have <code>folder/filename</code>; <code>folder</code> allowlist and <code>filename</code> checks prevent misuse.</li>
</ul>
<p><strong>Verdict:</strong> Mitigated.</p>
<hr>
<h3>9. Content of served HTML files</h3>
<p><strong>Risk:</strong> Built <code>.html</code> files may contain arbitrary script (e.g. from markdown or build pipeline). We serve them as-is.</p>
<p><strong>Analysis:</strong></p>
<ul>
<li>We don’t sanitize file contents. Trust boundary is “content under project control.” This is a conscious tradeoff for a local dev server.</li>
</ul>
<p><strong>Verdict:</strong> Accepted. Document as operational note; no code change.</p>
<hr>
<h2>Summary of code changes</h2>
<table>
<thead>
<tr>
<th>Item</th>
<th>Change</th>
</tr>
</thead>
<tbody><tr>
<td>Bind address</td>
<td>Listen on <code>HOST</code> (default <code>127.0.0.1</code>) instead of all interfaces</td>
</tr>
<tr>
<td>XSS</td>
<td>Escape <code>&#39;</code> in <code>escapeHtml</code></td>
</tr>
<tr>
<td>Null bytes</td>
<td>Reject <code>filename</code> containing <code>\0</code></td>
</tr>
<tr>
<td>HTTP method</td>
<td>405 for non-GET, <code>Allow: GET</code></td>
</tr>
</tbody></table>
<hr>
<h2>Operational notes</h2>
<ul>
<li><strong>Local use:</strong> Server is intended for local review. Don’t expose it to untrusted networks.</li>
<li><strong>Content trust:</strong> Served HTML is not sanitized; ensure built content is trusted.</li>
<li><strong>Dependencies:</strong> Uses only Node built-ins (<code>http</code>, <code>fs</code>, <code>path</code>); no additional dependency surface.</li>
</ul>

</body>
</html>
